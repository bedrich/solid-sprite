#!/usr/bin/env node

var fs = require('fs');
var colors = require('colors');
var exec = require('child_process').exec;
var path = require('path');

var args = process.argv.slice(2);
var opts = {
	grid: 30,
	input: path.resolve(process.cwd(), args[0]),
	output: path.resolve(process.cwd(), args[1] || 'solidsprite.png'),
	trim: (args[2] && args[2] === '-trim') ? true : false
};

if (!fs.existsSync(opts.input)) {
	console.log('✖ '.red + opts.input + ' does not exist.');
	process.exit(1);
} else {
	opts.images = fs.readdirSync(opts.input).map(function(img) { return opts.input + '/' + img; });
}

if (!opts.trim) {
	createSprite();
} else {
	trimImages(createSprite);
}

function trimImages (cb) {
	console.log('‣' + ' Trimming images...');
	exec('mogrify -trim ' + opts.images.join(' '), function (err, stdout, stderr) {
		if (err) throw err;
		console.log('✓'.green + ' Trimming completed');
		cb.call();
	});
}

function createSprite () {
	console.log('‣' + ' Piecing sprite together...');
	exec('identify ' + opts.images.join(' '), function (err, stdout, stderr) {
		if (err) throw err;
		var images_metadata = formatIdentify(stdout.split('\n'));

		exec('convert ' + formatMontageArgs(images_metadata), function (err, stdout, stderr) {
			if (err) throw err;
			console.log('✓'.green + ' Sprite completed.');
			console.log('‣ ' + opts.output);
		});
	});
}

function formatIdentify (id_arr) {
	var id_formatted = {
		info: { maxwidth: 0 },
		imgs: []
	};

	for (var i = 0, len= id_arr.length; i < len; i++) {
		var id_info = id_arr[i].split(' ');

		if (id_info.length > 1) {
			id_formatted.info.maxwidth = Math.max(id_formatted.info.maxwidth, id_info[2].split('x')[0]);
			id_formatted.imgs.push({
				'filepath': (i > 0) ? id_info[0].slice(0, -(2 + i.toString().length)) : id_info[0], // removes "[i]" from end of string
				'filetype': id_info[1],
				'size': {
					'h': id_info[2].split('x')[1],
					'w': id_info[2].split('x')[0]
				}
			});
		}
	}

	return id_formatted;
}

function formatMontageArgs(metadata) {
	var args = [];
	var y_pos = 0;

	for (var i = 0, len = metadata.imgs.length; i < len; i++) {
		var img = metadata.imgs[i];
		var square_pos = (y_pos / opts.grid);

		args.push(
			'-background',
			'gray',
			'-pointsize',
			'11',
			'-font',
			'Verdana',
			'-fill',
			'white',
			'-page',
			['+', metadata.info.maxwidth + opts.grid, '+', y_pos].join(''),
			['label:', '[', square_pos, ']', img.size.w, 'x', img.size.h].join(''),
			'-page',
			['+0+', y_pos].join(''),
			img.filepath);

		if (img.size.h > opts.grid) {
			y_pos += Math.ceil(img.size.h / opts.grid) * opts.grid;
		} else {
			y_pos += opts.grid;
		}
	}

	args.push(
		'-background',
		'none',
		'-mosaic',
		opts.output);
	return args.join(' ');
}